---
title: Vue是如何监测数据改变的
tags: 学习记录
---

# 数据监测 

> 为什么有的时候修改数据不好用？

## 引入
```html
<div id="demo">
<h2>学校名称：{{name}}</h2>
    <h2>学校地址：{{address}}</h2>
</div>

<script type="text/javascript">
    const vm = new Vue({
        el: '#demo',
        data: function () {
            return {
                name:'哈工大（深圳）',
                address:'深圳大学城'
            };
        }
    });
</script>
```
> 数据代理：vm.name、vm.address来自vm._data，而vm._data中的数据来自传入的data控制项
> 过程：①加工用户传入的data:{}，加入reactiveGetter和reactiveSetter（响应式，一改就重新解析）； ②vm._data=data   

## Vue Observer（对象监测）
> Vue通过构造函数Observer来监测数据

```javascript
// 创建一个监视的实例对象，用来监测data中属性的变化
    const obs = new Observer(data)

    function Observer(obj) {
        // 汇总对象所有属性，形成一个数组
        const keys = Object.keys(obj)
        // 遍历
        keys.forEach((k) => {
            Object.defineProperty(this, k, {
                get() {
                    return obj[k]
                },
                set(val) {
                	console.log('${k}被改了，提示。')
                    obj[k] = val
                }  
            })
        })
    }

```

## Vue.set() 的使用
> 中途在vm._data中加属性，并不会匹配一个getter和setter（setter会影响页面），也不会被加到vm中。
> 例如vm.student在初始化中有name和age两个属性，那么初始时会给这两个属性匹配一个getter和setter，如果使用vm._data.student.gender= "男"语句，此时不会正常被添加（非响应式）。
> 如何解决这个问题？——Vue.set()

```javascript
	// Vue.set(target, key, val)
	
	Vue.set(vm.student,'gender','男')
```
此时我们后添加的gender属性就成为了响应式了，与之前定义的属性一致

> vm.$set()方法：与Vue.set()效果一致

```javascript
vm.$set(vm.student,'gender','男')
```

> vm._data.student === vm.student （原理：数据代理）

> **注意！Vue.set()只能往data中某一个对象追加属性，而不能往data中追加属性（即vm和vm._data不允许作为Target**
> 官网文档描述：对象不能是 Vue 实例，或者是Vue实例的根数据对象

## Vue 数组监测
> 与前面的对象监测类似，但是又有不同。
> 数组与对象的一个区别是，对象中的key与数组中的index不一样
> Vue会建立与对象中key相对应的getter和setter，不会建立与数组中index对应的getter和setter

数组：push、pop、shift、unshift、splice、sort、reverse（反转）
这些方法都会引起数组自身的改变
在Vue中，只有调用这七种会影响原数组的修改方法，才会监测到数组发生了修改

```javascript
hobby:['吃饭', '睡觉']

vm.student.hobby.push('学习') // 响应式，页面会直接发生改变
vm.hobby[2] = '学习' // 直接修改数组索引对应值，此时页面不会发生改变，即Vue没有监测到数组的修改
```

> Vue 是如何监测到数组的修改？—— 包装
> vm.student.hobby.push('学习') 这里调用的push方法已经不是Array 原型对象中的push了，即Vue重写了这里的push方法
> 步骤：① 正常调用原型对象的push方法；② 重新解析模板、生成虚拟DOM等这一系列流程

> **其他方法：Vue.set(vm.student.hobby,2,'学习') 也是可以用的（或者vm.$set())**

## 内容总结
> 下面开始总结：

- Vue 会监测data中所有层次的数据

- 如何监测对象中的数据？通过setter实现监测，而且在new Vue时就要传入检测的数据

  如果需要后追加，默认不做响应式；如果需要响应式Vue.set(target, propertyName/index, value)或vm.$set(target, propertyName/index, value)

- 如何监测数组中的数据？①调用原生方法更新数据；②重新解析模板，更新页面

- 在 Vue 中修改数组：①七种API（push、pop、shift、unshift、unshift、splice、reverse）；②Vue.set()或vm.$set()

  不在这七种API中怎么办？ methods中写函数、回调（箭头函数）并重新给数组赋值（该方法没有通过数组index赋值，而是直接替换掉了原数组）

## 参考资料
[Vue - 列表渲染 - 数组更新监测](https://cn.vuejs.org/v2/guide/list.html#%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0%E6%A3%80%E6%B5%8B)


<!--more--> 

---

2021年8月26日

